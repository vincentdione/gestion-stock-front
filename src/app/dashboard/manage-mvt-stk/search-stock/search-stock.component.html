<div class="modern-stock-container">
  <!-- En-tête modernisée -->
  <div class="modern-header">
    <div class="header-content">
      <div class="title-section">
        <mat-icon class="title-icon">inventory</mat-icon>
        <div>
          <h1 class="page-title">Rechercher le stock des articles</h1>
          <p class="page-subtitle">Consultez les niveaux de stock par article et unité</p>
        </div>
      </div>
    </div>
  </div>

 <!-- Section de filtres -->
 <mat-card class="filter-card">
  <div class="filter-header">
    <mat-icon>search</mat-icon>
    <h3>Critères de recherche</h3>
  </div>

  <form [formGroup]="filterForm" class="filter-form">
    <div class="filter-grid">
      <!-- Article -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Article</mat-label>
        <mat-select formControlName="article">
          <!-- Template pour afficher la valeur sélectionnée -->
          <mat-select-trigger>
            <div *ngIf="filterForm.get('article')?.value" class="selected-value">
              <mat-icon class="trigger-icon">inventory_2</mat-icon>
              <span class="trigger-text">
                {{filterForm.get('article')?.value?.codeArticle}}
              </span>
            </div>
          </mat-select-trigger>

          <mat-option *ngFor="let u of articles" [value]="u">
            <div class="article-option">
              <mat-icon>inventory_2</mat-icon>
              <div class="option-details">
                <span class="option-code">{{u.codeArticle}}</span>
                <span class="option-name">{{u.designation}}</span>
              </div>
            </div>
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>category</mat-icon>
      </mat-form-field>

      <!-- Unité -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Unité</mat-label>
        <mat-select formControlName="unite">
          <!-- Template pour afficher la valeur sélectionnée -->
          <mat-select-trigger>
            <div *ngIf="filterForm.get('unite')?.value" class="selected-value">
              <mat-icon class="trigger-icon">straighten</mat-icon>
              <span class="trigger-text">
                {{filterForm.get('unite')?.value?.nom}}
              </span>
            </div>
          </mat-select-trigger>

          <mat-option *ngFor="let u of listeUnites" [value]="u">
            <div class="option-content">
              <mat-icon>straighten</mat-icon>
              <span>{{u.nom}}</span>
            </div>
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>square_foot</mat-icon>
      </mat-form-field>

      <!-- Type Mouvement -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Type Mouvement</mat-label>
        <mat-select formControlName="type">
          <!-- Template pour afficher la valeur sélectionnée -->
          <mat-select-trigger>
            <div *ngIf="filterForm.get('type')?.value" class="selected-value">
              <mat-icon class="trigger-icon"
                [style.color]="filterForm.get('type')?.value === 'entree' ? '#4CAF50' : '#F44336'">
                {{filterForm.get('type')?.value === 'entree' ? 'arrow_upward' : 'arrow_downward'}}
              </mat-icon>
              <span class="trigger-text">
                {{filterForm.get('type')?.value === 'entree' ? 'Entrée' : 'Sortie'}}
              </span>
            </div>
          </mat-select-trigger>

          <mat-option value="entree">
            <div class="type-option">
              <mat-icon style="color: #4CAF50;">arrow_upward</mat-icon>
              <span>Entrée</span>
            </div>
          </mat-option>
          <mat-option value="sortie">
            <div class="type-option">
              <mat-icon style="color: #F44336;">arrow_downward</mat-icon>
              <span>Sortie</span>
            </div>
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>swap_vert</mat-icon>
      </mat-form-field>

      <!-- Actions -->
      <div class="filter-actions">
        <button mat-stroked-button type="button" (click)="resetFilters()" class="reset-btn">
          <mat-icon>refresh</mat-icon>
          Réinitialiser
        </button>
        <button mat-flat-button color="primary" (click)="onSearch()" class="search-btn">
          <mat-icon>search</mat-icon>
          Rechercher
        </button>
      </div>
    </div>
  </form>
</mat-card>

  <!-- Statistiques globales -->
  <div class="stats-cards" *ngIf="dataSourceStock?.data?.length">
    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon">inventory_2</mat-icon>
        <div class="stat-text">
          <span class="stat-value">{{dataSourceStock.data.length}}</span>
          <span class="stat-label">Articles trouvés</span>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon">summarize</mat-icon>
        <div class="stat-text">
          <span class="stat-value">{{calculateTotalAllStock()}}</span>
          <span class="stat-label">Total stock</span>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon">trending_up</mat-icon>
        <div class="stat-text">
          <span class="stat-value">{{getAverageStock()}}</span>
          <span class="stat-label">Moyenne par article</span>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Section résultats -->
  <mat-card class="results-card">
    <div class="table-header">
      <div class="header-left">
        <mat-icon>list_alt</mat-icon>
        <h3>Résultats du stock</h3>
        <span class="count-badge" *ngIf="dataSourceStock?.data?.length">
          {{dataSourceStock.data.length}} résultat(s)
        </span>
      </div>
      <div class="header-right" *ngIf="dataSourceStock?.data?.length">
        <button mat-icon-button matTooltip="Exporter" (click)="exportToExcel()">
          <mat-icon>download</mat-icon>
        </button>
      </div>
    </div>

    <!-- État vide / Aucune recherche -->
    <div *ngIf="!dataSourceStock?.data?.length" class="empty-state">
      <mat-icon class="empty-icon">search_off</mat-icon>
      <h4>Aucun résultat</h4>
      <p *ngIf="!filterForm.value.article">Sélectionnez des critères pour rechercher le stock</p>
      <p *ngIf="filterForm.value.article">Aucun stock trouvé pour ces critères</p>
    </div>

    <!-- Tableau des résultats -->
    <div *ngIf="dataSourceStock?.data?.length" class="table-container">
      <div class="responsive-table">
        <!-- Version desktop -->
        <div class="desktop-view">
          <table mat-table [dataSource]="dataSourceStock" class="modern-table">

            <!-- Article Column -->
            <ng-container matColumnDef="article">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-content">
                  <mat-icon>inventory_2</mat-icon>
                  <span>Article</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let element">
                <div class="cell-article">
                  <mat-icon class="cell-icon">inventory</mat-icon>
                  <div class="article-info">
                    <span class="article-name">{{element?.name}}</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Stock Info Column -->
            <ng-container matColumnDef="stock">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-content">
                  <mat-icon>storage</mat-icon>
                  <span>Détails du stock</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let element">
                <div class="stock-details" *ngIf="element.stockInfo">
                  <div class="stock-items">
                    <div *ngFor="let key of getStockInfoKeys(element.stockInfo)" class="stock-item">
                      <div class="stock-label">{{key | titlecase}}:</div>
                      <div class="stock-value">{{element.stockInfo[key]}}</div>
                    </div>
                  </div>
                  <div class="stock-summary" *ngIf="calculateTotalStock(element.stockInfo) > 0">
                    <mat-icon class="summary-icon">summarize</mat-icon>
                    <span class="total-stock">
                      Total: {{calculateTotalStock(element.stockInfo)}}
                    </span>
                  </div>
                </div>
                <div class="no-stock" *ngIf="!element.stockInfo || getStockInfoKeys(element.stockInfo).length === 0">
                  <mat-icon>error_outline</mat-icon>
                  <span>Aucune information de stock disponible</span>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef>
                <div class="header-content">
                  <mat-icon>settings</mat-icon>
                  <span>Actions</span>
                </div>
              </th>
              <td mat-cell *matCellDef="let element">
                <div class="actions-container">
                  <button mat-icon-button color="primary" matTooltip="Modifier" class="action-btn">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="accent" matTooltip="Voir historique" class="action-btn">
                    <mat-icon>history</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <!-- Header row -->
            <tr mat-header-row *matHeaderRowDef="displayStockColumns"></tr>
            <!-- Data rows -->
            <tr mat-row *matRowDef="let row; columns: displayStockColumns"></tr>
          </table>
        </div>

        <!-- Version mobile (cartes) -->
        <div class="mobile-view">
          <div class="stock-cards">
            <mat-card *ngFor="let item of dataSourceStock.filteredData" class="stock-card">
              <mat-card-header>
                <div class="stock-header">
                  <mat-icon class="stock-icon">inventory</mat-icon>
                  <div class="header-content">
                    <mat-card-title>{{item?.name}}</mat-card-title>
                  </div>
                </div>
              </mat-card-header>

              <mat-card-content>
                <div class="stock-details-mobile" *ngIf="item.stockInfo">
                  <div class="stock-grid">
                    <div *ngFor="let key of getStockInfoKeys(item.stockInfo)" class="stock-item-mobile">
                      <span class="stock-label-mobile">{{key | titlecase}}:</span>
                      <span class="stock-value-mobile">{{item.stockInfo[key]}}</span>
                    </div>
                  </div>

                  <div class="stock-total-mobile" *ngIf="calculateTotalStock(item.stockInfo) > 0">
                    <mat-icon>summarize</mat-icon>
                    <span>Stock total: {{calculateTotalStock(item.stockInfo)}}</span>
                  </div>
                </div>

                <div class="no-stock-mobile" *ngIf="!item.stockInfo || getStockInfoKeys(item.stockInfo).length === 0">
                  <mat-icon>error_outline</mat-icon>
                  <span>Aucun stock disponible</span>
                </div>
              </mat-card-content>

              <mat-card-actions class="card-actions">
                <button mat-button color="primary">
                  <mat-icon>edit</mat-icon>
                  Modifier
                </button>
                <button mat-button color="accent">
                  <mat-icon>history</mat-icon>
                  Historique
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </div>
    </div>
  </mat-card>


</div>