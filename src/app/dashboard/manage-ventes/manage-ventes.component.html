<div class="vente-container">
  <!-- Header avec titre et statistiques -->
  <div class="header-section">
    <div class="header-content">
      <div class="title-section">
        <mat-icon class="title-icon">point_of_sale</mat-icon>
        <h1 class="page-title">Gestion des Ventes</h1>
      </div>
      <div class="stats-cards">
        <mat-card class="stat-card">
          <div class="stat-content">
            <mat-icon class="stat-icon">shopping_cart</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{dataVentes.length}}</span>
              <span class="stat-label">Ventes totales</span>
            </div>
          </div>
        </mat-card>
        <mat-card class="stat-card">
          <div class="stat-content">
            <mat-icon class="stat-icon">payments</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{totalCommande | currency:'F':'symbol':'1.0-0'}}</span>
              <span class="stat-label">Total commande</span>
            </div>
          </div>
        </mat-card>
      </div>
    </div>
  </div>

  <!-- Section formulaire d'ajout -->
  <div class="form-section">
    <mat-card class="form-card">
      <div class="card-header">
        <h2><mat-icon>add_circle</mat-icon> Nouvelle vente</h2>
        <p>Ajoutez des articles à la commande en cours</p>
      </div>

      <form [formGroup]="comVenteForm" class="vente-form">
        <!-- Mode de paiement -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Mode de paiement</mat-label>
            <mat-select formControlName="mode">
              <mat-option *ngFor="let mode of dataModePayement" [value]="mode">
                {{mode.code}}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>payment</mat-icon>
          </mat-form-field>
        </div>

        <!-- Section lignes de vente -->
        <div class="ligne-vente-section">
          <div class="section-title">
            <mat-icon>list_alt</mat-icon>
            <h3>Ajouter un article</h3>
          </div>

          <div class="form-grid">
            <!-- Article -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Article</mat-label>
              <mat-select formControlName="article" (selectionChange)="onArticleSelected($event.value)">
                <mat-option *ngFor="let condition of dataConditions" [value]="condition">
                  {{condition.article?.codeArticle}} - {{condition.article?.designation}}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>inventory_2</mat-icon>
            </mat-form-field>

            <!-- Unité -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Unité</mat-label>
              <mat-select formControlName="unite" (selectionChange)="onUniteSelected($event.value)">
                <mat-option *ngFor="let unite of dataUnites" [value]="unite">
                  {{unite.nom}}
                </mat-option>
              </mat-select>
              <mat-icon matPrefix>scale</mat-icon>
            </mat-form-field>

            <!-- Quantité -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Quantité</mat-label>
              <input matInput formControlName="quantite" type="number" min="1" required>
              <mat-icon matPrefix>format_list_numbered</mat-icon>
              <mat-error *ngIf="comVenteForm.get('quantite')?.invalid && comVenteForm.get('quantite')?.touched">
                La quantité est obligatoire
              </mat-error>
            </mat-form-field>

            <!-- Prix unitaire -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Prix unitaire</mat-label>
              <input matInput formControlName="prixUnitaire" type="number" min="0" step="0.01" readonly>
              <span matPrefix>F&nbsp;</span>
              <mat-icon matSuffix>attach_money</mat-icon>
            </mat-form-field>

            <!-- Bouton Ajouter -->
            <div class="add-button-container">
              <button mat-fab color="primary" class="add-button"
                      (click)="addLigneVente()"
                      [disabled]="!comVenteForm.get('article')?.value ||
                                  !comVenteForm.get('quantite')?.value ||
                                  !comVenteForm.get('unite')?.value">
                <mat-icon>add</mat-icon>
              </button>
              <span class="button-label">Ajouter</span>
            </div>
          </div>
        </div>
      </form>
    </mat-card>
  </div>

  <!-- Tableau des articles ajoutés -->
  <div class="table-section" *ngIf="lignesCommande.length > 0">
    <mat-card class="table-card">
      <div class="card-header">
        <h2><mat-icon>receipt_long</mat-icon> Articles ajoutés</h2>
        <span class="badge">{{lignesCommande.length}} articles</span>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="lignesCommande" class="vente-table">
          <!-- Colonne Code -->
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef class="table-header">
              <mat-icon>tag</mat-icon> Code
            </th>
            <td mat-cell *matCellDef="let element" class="table-cell code-cell">
              <div class="code-content">
                <mat-icon class="cell-icon">qr_code</mat-icon>
                <span>{{element.article?.codeArticle}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Unité -->
          <ng-container matColumnDef="unite">
            <th mat-header-cell *matHeaderCellDef class="table-header">
              <mat-icon>straighten</mat-icon> Unité
            </th>
            <td mat-cell *matCellDef="let element" class="table-cell">
              <span class="unite-badge">{{element.unite}}</span>
            </td>
          </ng-container>

          <!-- Colonne Quantité -->
          <ng-container matColumnDef="quantite">
            <th mat-header-cell *matHeaderCellDef class="table-header">
              <mat-icon>numbers</mat-icon> Quantité
            </th>
            <td mat-cell *matCellDef="let element" class="table-cell">
              <div class="quantite-cell">
                <span class="quantite-value">{{element.quantite}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Prix Unitaire -->
          <ng-container matColumnDef="prixUnitaire">
            <th mat-header-cell *matHeaderCellDef class="table-header">
              <mat-icon>monetization_on</mat-icon> Prix Unitaire
            </th>
            <td mat-cell *matCellDef="let element" class="table-cell price-cell">
              {{element.prixUnitaire | currency:'F':'symbol':'1.0-0'}}
            </td>
          </ng-container>

          <!-- Colonne Total -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef class="table-header">
              <mat-icon>calculate</mat-icon> Total
            </th>
            <td mat-cell *matCellDef="let element" class="table-cell total-cell">
              {{(element.quantite * element.prixUnitaire) | currency:'F':'symbol':'1.0-0'}}
            </td>
          </ng-container>

          <!-- Colonne Actions -->
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef class="table-header actions-header">
              <mat-icon>settings</mat-icon> Actions
            </th>
            <td mat-cell *matCellDef="let element" class="table-cell actions-cell">
              <button mat-icon-button color="warn"
                      matTooltip="Supprimer"
                      (click)="removeLigneVente(element)"
                      class="action-button">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayColumnVentes" class="table-header-row"></tr>
          <tr mat-row *matRowDef="let row; columns: displayColumnVentes" class="table-row"></tr>
        </table>
      </div>
    </mat-card>
  </div>

  <!-- Résumé et validation -->
  <div class="summary-section" *ngIf="lignesCommande.length > 0">
    <mat-card class="summary-card">
      <div class="summary-content">
        <div class="total-info">
          <div class="total-label">
            <mat-icon>summarize</mat-icon>
            <h3>Résumé de la commande</h3>
          </div>
          <div class="total-value">
            <span class="total-amount">{{totalCommande | currency:'F':'symbol':'1.0-0'}}</span>
            <span class="total-text">Total commande</span>
          </div>
        </div>

        <div class="summary-actions">
          <button mat-stroked-button color="basic" class="cancel-button" (click)="clearForm()">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
          <button mat-raised-button color="primary"
                  class="validate-button"
                  (click)="handleAdd()"
                  [disabled]="lignesCommande.length === 0 || !comVenteForm.get('mode')?.value">
            <mat-icon>check_circle</mat-icon>
            Valider la vente
          </button>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Historique des ventes -->
  <div class="history-section">
    <mat-card class="history-card">
      <div class="card-header">
        <h2><mat-icon>history</mat-icon> Historique des ventes</h2>
        <button mat-button color="primary" class="view-all-button">
          Voir tout <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>

      <div class="vente-list" *ngIf="dataVentes && dataVentes.length > 0; else noVentes">
        <mat-accordion class="vente-accordion">
          <mat-expansion-panel *ngFor="let element of dataVentes" class="vente-panel">
            <mat-expansion-panel-header class="panel-header">
              <mat-panel-title class="panel-title">
                <mat-icon>receipt</mat-icon>
                <div class="vente-info">
                  <span class="vente-code">{{element.code || 'Vente #' + element.id}}</span>
                  <span class="vente-date">{{element.dateVente | date: 'dd/MM/yyyy' }}</span>
                  <span class="vente-total">{{element.total | currency:'F':'symbol':'1.0-0'}}</span>
                </div>
              </mat-panel-title>
              <mat-panel-description class="panel-actions">
                <button mat-icon-button color="warn"
                        matTooltip="Supprimer"
                        (click)="handleDelete(element); $event.stopPropagation()"
                        class="panel-action-button">
                  <mat-icon>delete</mat-icon>
                </button>
                <button mat-icon-button color="primary"
                        matTooltip="Voir détails"
                        (click)="handleView(element); $event.stopPropagation()"
                        class="panel-action-button">
                  <mat-icon>visibility</mat-icon>
                </button>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="panel-content">
              <app-details-lignes-commandes
                [idCommande]="element?.id"
                [origin]="">
              </app-details-lignes-commandes>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>

      <ng-template #noVentes>
        <div class="empty-state">
          <mat-icon class="empty-icon">inventory</mat-icon>
          <h3>Aucune vente enregistrée</h3>
          <p>Commencez par ajouter une nouvelle vente</p>
        </div>
      </ng-template>
    </mat-card>
  </div>
</div>