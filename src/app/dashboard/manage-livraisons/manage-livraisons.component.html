<div class="modern-delivery-container">
  <!-- Header -->
  <div class="modern-header">
    <div class="header-content">
      <div class="title-section">
        <mat-icon class="title-icon">local_shipping</mat-icon>
        <div>
          <h1 class="page-title">Gestion des livraisons</h1>
          <p class="page-subtitle">Suivez et gérez toutes vos livraisons en temps réel</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon">local_shipping</mat-icon>
        <div class="stat-details">
          <span class="stat-value">{{dataSource?.data?.length || 0}}</span>
          <span class="stat-label">Livraisons totales</span>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon" style="color: #ff9800;">schedule</mat-icon>
        <div class="stat-details">
          <span class="stat-value">{{getStatusCount('EN_COURS')}}</span>
          <span class="stat-label">En cours</span>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon" style="color: #4CAF50;">check_circle</mat-icon>
        <div class="stat-details">
          <span class="stat-value">{{getStatusCount('VALIDER')}}</span>
          <span class="stat-label">Validées</span>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-content">
        <mat-icon class="stat-icon" style="color: #f44336;">cancel</mat-icon>
        <div class="stat-details">
          <span class="stat-value">{{getStatusCount('ANNULER') + getStatusCount('RENVOYER')}}</span>
          <span class="stat-label">Annulées/Renvois</span>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Filtres -->
<!-- Section Filtres - Version corrigée -->
<mat-card class="filter-card">
  <div class="filter-header">
    <mat-icon>filter_list</mat-icon>
    <h3>Filtrer les livraisons</h3>
  </div>

  <form [formGroup]="filterForm" class="filter-form">
    <div class="filter-grid">
      <!-- Filtre Article -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Rechercher par article</mat-label>
        <mat-select formControlName="article" [(ngModel)]="selectedArticle">
          <!-- Template pour afficher la valeur sélectionnée -->
          <mat-select-trigger>
            <div *ngIf="filterForm.get('article')?.value" class="selected-value">
              <mat-icon class="trigger-icon">inventory</mat-icon>
              <span class="trigger-text">
                {{filterForm.get('article')?.value?.codeArticle}}
              </span>
            </div>
          </mat-select-trigger>

          <mat-option>-- Tous les articles --</mat-option>
          <mat-option *ngFor="let article of articles" [value]="article">
            <div class="article-option">
              <mat-icon>inventory</mat-icon>
              <div class="article-details">
                <span class="article-code">{{article.codeArticle}}</span>
                <span class="article-name" *ngIf="article.designation">{{article.designation}}</span>
              </div>
            </div>
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Filtre Statut -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Statut</mat-label>
        <mat-select formControlName="status">
          <!-- Template pour afficher la valeur sélectionnée -->
          <mat-select-trigger>
            <div *ngIf="filterForm.get('status')?.value" class="selected-value">
              <mat-icon class="trigger-icon"
                        [style.color]="getStatusIconColor(filterForm.get('status')?.value)">
                {{getStatusIcon(filterForm.get('status')?.value)}}
              </mat-icon>
              <span class="trigger-text">
                {{getStatusLabel(filterForm.get('status')?.value)}}
              </span>
            </div>
          </mat-select-trigger>

          <mat-option value="">Tous les statuts</mat-option>
          <mat-option value="EN_COURS">
            <div class="status-option">
              <mat-icon style="color: #ff9800;">schedule</mat-icon>
              <span>En cours</span>
            </div>
          </mat-option>
          <mat-option value="VALIDER">
            <div class="status-option">
              <mat-icon style="color: #4CAF50;">check_circle</mat-icon>
              <span>Validée</span>
            </div>
          </mat-option>
          <mat-option value="ANNULER">
            <div class="status-option">
              <mat-icon style="color: #f44336;">cancel</mat-icon>
              <span>Annulée</span>
            </div>
          </mat-option>
          <mat-option value="RENVOYER">
            <div class="status-option">
              <mat-icon style="color: #9c27b0;">keyboard_return</mat-icon>
              <span>Renvoyée</span>
            </div>
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>flag</mat-icon>
      </mat-form-field>

      <!-- Actions - Maintenant alignés sur la même ligne -->
      <div class="filter-actions">
        <button mat-stroked-button type="button" (click)="resetFilters()" class="reset-btn">
          <mat-icon>refresh</mat-icon>
          Réinitialiser
        </button>
        <button mat-flat-button color="primary" (click)="onSearch()" class="search-btn">
          <mat-icon>search</mat-icon>
          Rechercher
        </button>
      </div>
    </div>
  </form>
</mat-card>

  <!-- Tableau des livraisons -->
  <mat-card class="results-card">
    <div class="table-header">
      <div class="header-left">
        <mat-icon>list_alt</mat-icon>
        <h3>Liste des livraisons</h3>
        <span class="count-badge" *ngIf="dataSource?.data?.length">
          {{dataSource.data.length}} livraison(s)
        </span>
      </div>
      <div class="header-right">
        <button mat-icon-button matTooltip="Actualiser" (click)="tableData()">
          <mat-icon>refresh</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Exporter" (click)="exportToExcel()">
          <mat-icon>download</mat-icon>
        </button>
      </div>
    </div>

    <!-- État vide -->
    <div *ngIf="!dataSource?.data?.length" class="empty-state">
      <mat-icon class="empty-icon">local_shipping</mat-icon>
      <h4>Aucune livraison trouvée</h4>
      <p>Il n'y a actuellement aucune livraison dans le système</p>
    </div>

    <!-- Version desktop -->
    <div *ngIf="dataSource?.data?.length" class="table-container">
      <div class="desktop-view">
        <table mat-table [dataSource]="dataSource" class="modern-table">

          <!-- Code -->
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef>
              <div class="header-content">
                <mat-icon>tag</mat-icon>
                <span>Code</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element">
              <div class="code-cell">
                <mat-icon class="cell-icon">qr_code</mat-icon>
                <span class="code-value">{{element.code}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Date Livraison -->
          <ng-container matColumnDef="dateLivraison">
            <th mat-header-cell *matHeaderCellDef>
              <div class="header-content">
                <mat-icon>event</mat-icon>
                <span>Date livraison</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element">
              <div class="date-cell">
                <mat-icon>today</mat-icon>
                <span>{{element.dateLivraison | date: 'dd/MM/yyyy'}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Statut -->
          <ng-container matColumnDef="etat">
            <th mat-header-cell *matHeaderCellDef>
              <div class="header-content">
                <mat-icon>flag</mat-icon>
                <span>Statut</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element">
              <div [ngClass]="getStatusClass(element.etat)" class="status-badge">
                <mat-icon>{{getStatusIcon(element.etat)}}</mat-icon>
                <span>{{element.etat}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Client -->
          <ng-container matColumnDef="client">
            <th mat-header-cell *matHeaderCellDef>
              <div class="header-content">
                <mat-icon>person</mat-icon>
                <span>Client</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element">
              <div class="client-cell">
                <mat-icon>account_circle</mat-icon>
                <div class="client-info">
                  <span class="client-name">{{element.commandeClient.clientDto.prenom}} {{element.commandeClient.clientDto.nom}}</span>
                  <span class="client-code" *ngIf="element.commandeClient.clientDto.email">
                    {{element.commandeClient.clientDto.email}}
                  </span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Livreur -->
          <ng-container matColumnDef="livreur">
            <th mat-header-cell *matHeaderCellDef>
              <div class="header-content">
                <mat-icon>directions_bike</mat-icon>
                <span>Livreur</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element">
              <div class="livreur-cell">
                <mat-icon>delivery_dining</mat-icon>
                <div class="livreur-info">
                  <span class="livreur-name" *ngIf="element.utilisateur">
                    {{element.utilisateur.prenom}} {{element.utilisateur.nom}}
                  </span>
                  <span class="no-livreur" *ngIf="!element.utilisateur">
                    Non assigné
                  </span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef>
              <div class="header-content">
                <mat-icon>settings</mat-icon>
                <span>Actions</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let element">
              <div class="actions-container">
                <button mat-icon-button color="primary" matTooltip="Détails" (click)="viewDetails(element)">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button color="accent" matTooltip="Modifier" (click)="editDelivery(element)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" matTooltip="Annuler"
                        *ngIf="element.etat === 'EN_COURS'" (click)="cancelDelivery(element)">
                  <mat-icon>cancel</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayColumns"></tr>
        </table>
      </div>

      <!-- Version mobile -->
      <div class="mobile-view">
        <div class="delivery-cards">
          <mat-card *ngFor="let delivery of dataSource.filteredData" class="delivery-card">
            <mat-card-header>
              <mat-card-title>
                <div class="card-title-row">
                  <mat-icon>local_shipping</mat-icon>
                  <span>{{delivery.code}}</span>
                  <div [ngClass]="getStatusClass(delivery?.etat)" class="status-badge-mobile">
                    {{delivery.etat}}
                  </div>
                </div>
              </mat-card-title>
              <mat-card-subtitle>
                {{delivery.dateLivraison | date: 'dd/MM/yyyy'}}
              </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <div class="delivery-info">
                <div class="info-row">
                  <mat-icon>person</mat-icon>
                  <div class="info-content">
                    <span class="info-label">Client</span>
                    <span class="info-value">
                      {{delivery.commandeClient?.clientDto?.prenom}} {{delivery.commandeClient?.clientDto?.nom}}
                    </span>
                  </div>
                </div>

                <div class="info-row">
                  <mat-icon>delivery_dining</mat-icon>
                  <div class="info-content">
                    <span class="info-label">Livreur</span>
                    <span class="info-value" *ngIf="delivery.utilisateur">
                      {{delivery.utilisateur.prenom}} {{delivery.utilisateur.nom}}
                    </span>
                    <span class="info-value no-livreur" *ngIf="!delivery.utilisateur">
                      Non assigné
                    </span>
                  </div>
                </div>

                <!-- Quantité retirée de la version mobile aussi -->
                <!-- Date Mouvement retirée de la version mobile aussi -->
              </div>
            </mat-card-content>

            <mat-card-actions>
              <button mat-button color="primary" (click)="viewDetails(delivery)">
                <mat-icon>visibility</mat-icon>
                Détails
              </button>
              <button mat-button color="accent" (click)="editDelivery(delivery)">
                <mat-icon>edit</mat-icon>
                Modifier
              </button>
              <button mat-button color="warn" *ngIf="delivery.etat === 'EN_COURS'" (click)="cancelDelivery(delivery)">
                <mat-icon>cancel</mat-icon>
                Annuler
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons
                     [length]="dataSource?.data?.length || 0"
                     [pageSize]="10">
      </mat-paginator>
    </div>
  </mat-card>
</div>